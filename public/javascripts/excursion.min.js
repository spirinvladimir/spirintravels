var canvas,c,timer,gtime=new Date,start_time=gtime.getTime(),gtime_last,image=new Image,background_is_load=0,boli=[],boli_ready=[],calculate_displacement_finish=0,boli_play=0,list_excursiones,excursion_timer,excursion_ball=[],time_of_life=4E3,size_cb=0,descrip;
function visible_delete_excursiones(){var a=(new Date).getTime(),b;b=[];var e;size_cb=0;for(e in c.b)if(c.b.hasOwnProperty(e)&&(size_cb++,c.b[e].hasOwnProperty("time_life")&&(!c.b[e].hasOwnProperty("skip_hide")||c.b[e].hasOwnProperty("skip_hide")&&0===c.b[e].skip_hide)))c.b[e].time_life<a?delete c.b[e]:(b=c.b[e].color,b=b.replace("rgba(",""),b=b.replace(")",""),b=b.split(","),b[3]=0.6*(c.b[e].time_life-a)/time_of_life,c.b[e].color="rgba("+b[0]+","+b[1]+","+b[2]+","+b[3]+")")}
function find_city_in_hash(a){for(var b in c.b)if(c.b.hasOwnProperty(b)&&c.b[b].text===a)return{x:c.b[b].x,y:c.b[b].y};return 0}
function este_es_balon_excursion_dibujo_ruta(a){var b=(new Date).getTime(),e,d,f,i,j,g,h,k,m,n,l;a.time_life=b+time_of_life;e=a.color;e=e.replace("rgba(","");e=e.replace(")","");e=e.split(",");e[3]=0.9;a.color="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")";a.skip_hide=1;$.ajax({type:"POST",url:a.link,async:!0,dataType:"json"}).done(function(a){descrip=jQuery.parseJSON(a);for(a=0;a<descrip.fotos.length;a++){descrip.hasOwnProperty("images")||(descrip.images=[],descrip.peon=new Image,descrip.peon.onload=
function(){descrip.peon_load=1},descrip.peon.src="/images/peon.bmp");var b=new Image;descrip.images.push({link:descrip.fotos[a],image:b,load:0})}load_images_async()});for(e=0;e<a.ruta.length-1;e++)if(g=find_city_in_hash(a.ruta[e]),h=find_city_in_hash(a.ruta[e+1]),g&&h){f=g.x;i=h.x;g=g.y;h=h.y;d=Math.sqrt((i-f)*(i-f)+(h-g)*(h-g));n=parseInt(d/8,10);m=Math.abs((i-f)/n);for(d=1;d<n;d++){j=i>f?f+m*d:i+m*d;k=(h-g)/(i-f)*j+g-f*(h-g)/(i-f);for(l="b"+Math.random();c.b.hasOwnProperty(l);)l="b"+Math.random();
c.b[""+l]={x:parseInt(j,10),y:parseInt(k,10),color:"rgba(250,150,30,0.9)",move:0,text:"",r:3,re_draw:0,time_life:b+time_of_life}}}}
function select_excursiones(a){var b,e=0,d,f;if(a.hasOwnProperty("time_life"))a.hasOwnProperty("ruta")&&este_es_balon_excursion_dibujo_ruta(a);else if(list_excursiones.hasOwnProperty("list"))for(d=0;d<list_excursiones.list.length;d++)for(b=0;b<list_excursiones.list[d].city.length;b++)if(list_excursiones.list[d].city[b]===a.text){b=new Date;b=b.getTime();for(f="b"+Math.random();c.b.hasOwnProperty(f);)f="b"+Math.random();c.b[""+f]={x:parseInt(a.x,10),y:parseInt(a.y+3*a.r/2*e,10),color:"rgba(85,20,170,0.6)",
move:0,text:"",r:parseInt(a.r/2,10),re_draw:0,time_life:b+time_of_life,ruta:list_excursiones.list[d].city,link:list_excursiones.list[d].link};e++;b=list_excursiones.list[d].city.length}}function un_select_excursiones(a){var b;a.hasOwnProperty("time_life")&&(b=new Date,b=b.getTime(),a.time_life=b+time_of_life,b=a.color,b=b.replace("rgba(",""),b=b.replace(")",""),b=b.split(","),b[3]=0.9,a.color="rgba("+b[0]+","+b[1]+","+b[2]+","+b[3]+")",a.skip_hide=0)}
function load_images_async(){var a;for(a=0;a<descrip.images.length;a++)descrip.images[a].image.onload=function(){var a;for(a=0;a<descrip.images.length;a++)if(this.src===descrip.images[a].link){if(descrip.images[a].hasOwnProperty("xy"))break;for(var e=0.05*canvas.width/(descrip.images.length+1),d=0.45*canvas.width/descrip.images.length,f=0.75*d;f>0.25*canvas.height;)d--,f=0.75*d;descrip.images[a].xy={x1:0.5*canvas.width+e*(a+1)+d*a,y1:0.75*canvas.height,x2:0.5*canvas.width+e*(a+1)+d*(a+1),y2:0.75*
canvas.height+f};a=descrip.images.length}},descrip.images[a].image.src=descrip.images[a].link}function wrapText(a,b,e,d,f,i){var b=b.split(" "),j="",g,h,k;for(g=0;g<b.length;g+=1)h=j+b[g]+" ",k=a.measureText(h),k=k.width,k>f?(a.fillText(j,e,d),j=b[g]+" ",d+=i):j=h;a.fillText(j,e,d)}
function doScene(){var a=canvas.getContext("2d"),b,e;a.clearRect(0,0,canvas.width,canvas.height);a.font="40pt Tangerine";a.fillStyle="rgba(30,55,120,1)";a.fillText(document.title,0.5*canvas.width,0.09*canvas.height);a.font="15pt Tangerine";a.fillStyle="rgba(30,55,0,0.8)";a.fillText("Tel. +7 926 145 33 16",0.75*canvas.width,0.03*canvas.height);a.fillText("Tel. +34 691 296 658",0.75*canvas.width,0.07*canvas.height);a.fillText("spirin.vladimir@gmail.com",0.75*canvas.width,0.11*canvas.height);for(e=0;e<
boli_ready.length;e++)a.beginPath(),a.arc(boli_ready[e].x,boli_ready[e].y,5,0,2*Math.PI,!1),a.fillStyle="rgba(0,155,30,1)",a.fill(),a.closePath();for(b in c.b)a.beginPath(),a.arc(c.b[b].x,c.b[b].y,c.b[b].r,0,2*Math.PI,!1),a.fillStyle=c.b[b].color,a.fill(),a.closePath(),a.font=c.lineHeight+"pt Tangerine",a.fillStyle=c.b[b].color,wrapText(a,c.b[b].text,c.b[b].x+c.b[b].r,c.b[b].y,c.maxWidth,c.lineHeight+5);if("object"===typeof descrip){a.font="18pt Tangerine";a.fillStyle="rgba(230,125,20,1)";wrapText(a,
descrip.title,0.5*canvas.width,0.15*canvas.height,canvas.width/2,c.lineHeight+8);a.font="14pt Tangerine";a.fillStyle="rgba(40,40,90,1)";wrapText(a,descrip.text,0.5*canvas.width,0.2*canvas.height,canvas.width/2,c.lineHeight+8);if(descrip.hasOwnProperty("peon_load")){if(0<descrip.price[0]){for(e=0;3>e;e++)a.drawImage(descrip.peon,0.5*canvas.width+30*e,0.6*canvas.height,30,30),a.font="18pt Tangerine",a.fillStyle="rgba(250,175,30,1)";wrapText(a,descrip.price[0]+" \u20ac",0.5*canvas.width+90,0.65*canvas.height,
canvas.width/3,c.lineHeight+8)}if(0<descrip.price[1]){for(e=0;2>e;e++)a.drawImage(descrip.peon,0.5*canvas.width+30*e,0.6*canvas.height+30,30,30),a.font="18pt Tangerine",a.fillStyle="rgba(250,175,30,1)";wrapText(a,descrip.price[1]+" \u20ac",0.5*canvas.width+60,0.65*canvas.height+30,canvas.width/3,c.lineHeight+8)}if(0<descrip.price[2]){for(e=0;1>e;e++)a.drawImage(descrip.peon,0.5*canvas.width+30*e,0.6*canvas.height+60,30,30),a.font="18pt Tangerine",a.fillStyle="rgba(250,175,30,1)";wrapText(a,descrip.price[2]+
" \u20ac",0.5*canvas.width+30,0.65*canvas.height+60,canvas.width/3,c.lineHeight+8)}}for(e=0;e<descrip.images.length;e++)descrip.images[e].hasOwnProperty("xy")&&(a.drawImage(descrip.images[e].image,descrip.images[e].xy.x1,descrip.images[e].xy.y1,descrip.images[e].xy.x2-descrip.images[e].xy.x1,descrip.images[e].xy.y2-descrip.images[e].xy.y1),c.m_down.x>canvas.width/2&&descrip.images[e].xy.x1<c.m_down.x&&descrip.images[e].xy.y1<c.m_down.y&&descrip.images[e].xy.x2>c.m_down.x&&descrip.images[e].xy.y2>
c.m_down.y&&(a.beginPath(),a.rect(descrip.images[e].xy.x1,descrip.images[e].xy.y1,descrip.images[e].xy.x2-descrip.images[e].xy.x1,descrip.images[e].xy.y2-descrip.images[e].xy.y1),a.lineWidth=5,a.strokeStyle="black",a.stroke()))}a.save();a.translate(canvas.width/14,canvas.height/5);a.rotate(-Math.PI/3.5);a.font="18pt Calibri";a.textAlign="center";a.fillStyle="red";a.fillText("\u042d\u043a\u0441\u043a\u0443\u0440\u0441\u0438\u0438 \u043f\u043e \u0413\u0440\u0430\u043d \u041a\u0430\u043d\u0430\u0440\u0438\u0438",
3,10);a.restore()}function getCursorPosition(a){var b;a.pageX||a.pageY?(b=a.pageX,a=a.pageY):(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,a=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);b-=canvas.offsetLeft;a-=canvas.offsetTop;return{x:b,y:a}}function near(a,b,e,d,f){return Math.pow(a-e,2)+Math.pow(b-d,2)<=Math.pow(f,2)?1:0}
function md(a){var a=getCursorPosition(a),b;c.m_down=a;for(b in c.b)c.b.hasOwnProperty(b)&&near(a.x,a.y,c.b[b].x,c.b[b].y,c.b[b].r)&&(c.b[b].move=1);for(b in c.b)if(c.b.hasOwnProperty(b)&&1===c.b[b].move){timer=new Date;break}}function SlideShow_start(a){var a=a.replace("_M.","_orig."),b=window.open("","RecipeWindow",""),a='<html><head><title>SpirinTravels</title></head><body><img src="'+a+'"/></body></html>';b.document.open();b.document.write(a);b.document.close()}
function mu(){var a,b=0;for(a in c.b)c.b.hasOwnProperty(a)&&1===c.b[a].move&&(b+=1);if(1<b)for(a in c.b)c.b.hasOwnProperty(a)&&1===c.b[a].move&&(c.b[a].move=0);else{for(a in c.b)c.b.hasOwnProperty(a)&&1===c.b[a].move&&(b=new Date,300>b-timer&&"blog"===c.b[a].text&&(window.location.href+="blog"),c.b[a].move=0);if(c.m_down.x>canvas.width/2&&descrip.hasOwnProperty("images"))for(a=0;a<descrip.images.length;a++)descrip.images[a].hasOwnProperty("xy")&&descrip.images[a].xy.x1<c.m_down.x&&descrip.images[a].xy.y1<
c.m_down.y&&descrip.images[a].xy.x2>c.m_down.x&&descrip.images[a].xy.y2>c.m_down.y&&SlideShow_start(descrip.images[a].link)}}
function mm(a){var b,e,a=getCursorPosition(a),d;b=0;for(d in c.b)c.b.hasOwnProperty(d)&&(near(a.x,a.y,c.b[d].x,c.b[d].y,c.b[d].r)?(0===c.b[d].re_draw&&(c.b[d].color=c.b[d].color.replace("0.6","0.9"),c.b[d].r*=1.5,select_excursiones(c.b[d])),c.b[d].re_draw=1):(1===c.b[d].re_draw&&(c.b[d].color=c.b[d].color.replace("0.9","0.6"),c.b[d].r/=1.5,un_select_excursiones(c.b[d])),c.b[d].re_draw=0));for(d in c.b)if(c.b.hasOwnProperty(d)&&1===c.b[d].move){b=1;break}if(1===b)for(d in b=a.x-c.m_down.x,e=a.y-c.m_down.y,
c.b)c.b.hasOwnProperty(d)&&1===c.b[d].move&&(c.b[d].x+=b,c.b[d].y+=e,c.b[d].x+c.b[d].r>canvas.width?(near(a.x,a.y,c.b[d].x,c.b[d].y,c.b[d].r)||(c.b[d].move=0),c.b[d].x=canvas.width-c.b[d].r):c.b[d].y+c.b[d].r>canvas.height?(near(a.x,a.y,c.b[d].x,c.b[d].y,c.b[d].r)||(c.b[d].move=0),c.b[d].y=canvas.height-c.b[d].r):0>c.b[d].x-c.b[d].r?(near(a.x,a.y,c.b[d].x,c.b[d].y,c.b[d].r)||(c.b[d].move=0),c.b[d].x=c.b[d].r):0>c.b[d].y-c.b[d].r&&(near(a.x,a.y,c.b[d].x,c.b[d].y,c.b[d].r)||(c.b[d].move=0),c.b[d].y=
c.b[d].r));c.m_down=a}function mou(){for(var a in c.b)c.b.hasOwnProperty(a)&&(c.b[a].move=0)}
function calculate_displacement(){if(!(1===calculate_displacement_finish||1<=c.boli.length)){var a=1,b;for(b in c.b)if(c.b[b].y<c.b[b].y_din&&(a=Math.floor((c.b[b].y_din-c.b[b].y)/10),0===a&&(a=1),c.b[b].y+=a,a=0),c.b[b].y>c.b[b].y_din&&(a=Math.floor((c.b[b].y-c.b[b].y_din)/10),0===a&&(a=1),c.b[b].y-=a,a=0),c.b[b].x<c.b[b].x_din&&(a=Math.floor((c.b[b].x_din-c.b[b].x)/10),0===a&&(a=1),c.b[b].x+=a,a=0),c.b[b].x>c.b[b].x_din)a=Math.floor((c.b[b].x-c.b[b].x_din)/10),0===a&&(a=1),c.b[b].x-=a,a=0;1===a&&
(calculate_displacement_finish=1)}}function calculate_boli(){for(var a,b=(new Date).getTime()-start_time;1<=c.boli.length&&c.boli[0][2]/6<b;)a=c.boli.shift(),a[0]*=canvas.width,a[1]*=canvas.height,boli_ready.push({x:a[0],y:a[1],t:a[2]})}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();
function init(a){canvas=document.getElementsByTagName("canvas")[0];canvas.width=0.965*$(document).width();canvas.height=0.965*$(document).height();var b;$.ajax({type:"POST",url:a,data:{width:canvas.width,height:canvas.height},async:!1,dataType:"json"}).done(function(a){c=jQuery.parseJSON(a)});$.ajax({type:"POST",url:"/list_excursiones",async:!0,dataType:"json"}).done(function(a){list_excursiones=jQuery.parseJSON(a)});canvas.addEventListener("mousemove",mm,!1);canvas.addEventListener("mouseup",mu,
!1);canvas.addEventListener("mousedown",md,!1);canvas.addEventListener("mouseout",mou,!1);for(b in c.b)c.b[b].x_din=c.b[b].x,c.b[b].y_din=c.b[b].y,c.b[b].x=canvas.width-c.b[b].r,c.b[b].y=canvas.height-c.b[b].r;(function d(){requestAnimFrame(d);calculate_displacement();calculate_boli();visible_delete_excursiones();doScene()})()};
