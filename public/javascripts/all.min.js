var cv,c,image,timer,filename;image=new Image;var background_is_load=0;function drawImage_calc(b,a,e,d,f){var i,j,g,h;h=f;h>e&&(g=d*(e/f),h=e);g>a&&(g=a,h=a*f/d);j=i=0;d=g;f=h;g<a&&(i+=(a-g)/2,d+=(a-g)/2);h<e&&(j+=(e-h)/2,f+=(e-h)/2);b.drawImage(image,i,j,d,f)}function wrapText(b,a,e,d,f,i){var a=a.split(" "),j="",g,h,k;for(g=0;g<a.length;g+=1)h=j+a[g]+" ",k=b.measureText(h),k=k.width,k>f?(b.fillText(j,e,d),j=a[g]+" ",d+=i):j=h;b.fillText(j,e,d)}
function draw_arrow_left(b,a){b.beginPath();b.moveTo(a.x-0.85*a.r,a.y);b.lineTo(a.x+0.8*a.r,a.y);b.moveTo(a.x-0.8*a.r,a.y);b.lineTo(a.x-0.2*a.r,a.y+0.2*a.r);b.moveTo(a.x-0.8*a.r,a.y);b.lineTo(a.x-0.2*a.r,a.y-0.2*a.r);b.stroke();b.closePath()}function draw_arrow_right(b,a){b.beginPath();b.moveTo(a.x+0.85*a.r,a.y);b.lineTo(a.x-0.8*a.r,a.y);b.moveTo(a.x+0.8*a.r,a.y);b.lineTo(a.x+0.2*a.r,a.y+0.2*a.r);b.moveTo(a.x+0.8*a.r,a.y);b.lineTo(a.x+0.2*a.r,a.y-0.2*a.r);b.stroke();b.closePath()}
function draw_plus(b,a){b.beginPath();b.moveTo(a.x+0.5*a.r,a.y);b.lineTo(a.x-0.5*a.r,a.y);b.moveTo(a.x,a.y+0.5*a.r);b.lineTo(a.x,a.y-0.5*a.r);b.stroke();b.closePath()}function draw_minus(b,a){b.beginPath();b.moveTo(a.x+0.5*a.r,a.y);b.lineTo(a.x-0.5*a.r,a.y);b.stroke();b.closePath()}
function draw_notepad(b,a){b.beginPath();var e=a.r,d=2/3*e;b.lineWidth=1;b.moveTo(a.x-0.5*d,a.y+0.5*e);b.lineTo(a.x+0.5*d,a.y+0.5*e);b.moveTo(a.x+0.5*d,a.y+0.5*e);b.lineTo(a.x+0.5*d,a.y-0.5*e);b.moveTo(a.x+0.5*d,a.y-0.5*e);b.lineTo(a.x-d/6,a.y-0.5*e);b.moveTo(a.x-0.5*d,a.y+0.5*e);b.lineTo(a.x-0.5*d,a.y-(e/2-d/3));b.moveTo(a.x-d/6,a.y-0.5*e);b.lineTo(a.x-d/6,a.y-(e/2-d/3));b.moveTo(a.x-d/6,a.y-0.5*e);b.lineTo(a.x-0.5*d,a.y-(e/2-d/3));b.moveTo(a.x-0.5*d,a.y-(e/2-d/3));b.lineTo(a.x-d/6,a.y-(e/2-d/3));
b.moveTo(a.x-d/3,a.y-e/8);b.lineTo(a.x+d/3,a.y-e/8);b.moveTo(a.x-d/3,a.y+0.5*e/8);b.lineTo(a.x+d/3,a.y+0.5*e/8);b.moveTo(a.x-d/3,a.y+2*e/8);b.lineTo(a.x+d/3,a.y+2*e/8);b.stroke();b.closePath()}function draw_count(b,a,e,d){b.font=a.r+"pt Calibri";b.fillStyle="white";a.tmp?b.fillText(a.tmp+"/"+d,a.x,a.y):b.fillText(e+"/"+d,a.x,a.y)}
function doScene(){var b=cv.getContext("2d"),a;b.clearRect(0,0,cv.width,cv.height);1===background_is_load&&b.drawImage(image,0,0,cv.width,cv.height);b.lineWidth=5;for(a in c.b)if(c.b.hasOwnProperty(a)&&("r"===a||"l"===a||"notepad"===a||"count"===a))b.beginPath(),b.arc(c.b[a].x,c.b[a].y,c.b[a].r,0,2*Math.PI,!1),b.fillStyle=c.b[a].color,b.fill(),b.closePath(),"l"===a&&draw_arrow_left(b,c.b[a]),"r"===a&&draw_arrow_right(b,c.b[a]),"notepad"===a&&draw_notepad(b,c.b[a]),"count"===a&&draw_count(b,c.b[a],
c.order,c.count)}function draw(b){image.onload=function(){background_is_load=1;doScene()};image.src=b}function getCursorPosition(b){var a;b.pageX||b.pageY?(a=b.pageX,b=b.pageY):(a=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,b=b.clientY+document.body.scrollTop+document.documentElement.scrollTop);a-=cv.offsetLeft;b-=cv.offsetTop;return{x:a,y:b}}
function obj_parseInt(){for(var b in c.b)c.b.hasOwnProperty(b)&&(c.b[b].x=parseInt(c.b[b].x,10),c.b[b].y=parseInt(c.b[b].y,10),c.b[b].r=parseInt(c.b[b].r,10),c.b[b].move=parseInt(c.b[b].move,10));c.b.hasOwnProperty("count")&&c.b.count.tmp&&delete c.b.count.tmp;c.m_down.x=parseInt(c.m_down.x,10);c.m_down.y=parseInt(c.m_down.y,10);c.order=parseInt(c.order,10);c.count=parseInt(c.count,10);c.text.maxWidth=parseInt(c.text.maxWidth,10);c.text.lineHeight=parseInt(c.text.lineHeight,10)}
function send_next(){debug?c.image="images/DSC_0017.JPG"===c.image?"images/DSC_0585.JPG":"images/DSC_0017.JPG":$.ajax({type:"POST",url:"/next",data:c,async:!1,dataType:"json"}).done(function(b){c=jQuery.parseJSON(b);obj_parseInt()})}function send_jumpto(){$.ajax({type:"POST",url:"/jumpto",data:c,async:!1,dataType:"json"}).done(function(b){c=jQuery.parseJSON(b);obj_parseInt()})}
function keyup(b){if(0===b.keyCode)return!1;48<=b.keyCode&&57>=b.keyCode?c.b.count.tmp?!0===isNaN(c.b.count.tmp[0])?(c.b.count.tmp=10<=c.count?b.keyCode-48+"_":(b.keyCode-48).toString(),doScene()):10<=c.count&&!0===isNaN(c.b.count.tmp[1])&&(c.b.count.tmp=c.b.count.tmp[0].toString()+(b.keyCode-48).toString(),doScene()):cv.removeEventListener("keyup",keyup,!1):13===b.keyCode&&(!1===isNaN(c.b.count.tmp)?c.b.count.tmp<=c.count&&0<c.b.count.tmp?(c.order=parseInt(c.b.count.tmp,10),delete c.b.count.tmp,
send_jumpto(),draw(c.image),"block"===document.getElementById("chat").style.display&&$("#chat").fadeOut("slow")):delete c.b.count.tmp:10<=c.count&&!0===isNaN(c.b.count.tmp[1])&&!1===isNaN(c.b.count.tmp[0])&&0<parseInt(c.b.count.tmp[0],10)?(c.b.count.tmp=c.b.count.tmp[0],c.order=parseInt(c.b.count.tmp,10),delete c.b.count.tmp,send_jumpto(),draw(c.image),"block"===document.getElementById("chat").style.display&&$("#chat").fadeOut("slow")):delete c.b.count.tmp,cv.removeEventListener("keyup",keyup,!1),
doScene());return!1}function near(b,a,e,d,f){return Math.pow(b-e,2)+Math.pow(a-d,2)<=Math.pow(f,2)?1:0}function md(b){var b=getCursorPosition(b),a;c.m_down=b;for(a in c.b)c.b.hasOwnProperty(a)&&near(b.x,b.y,c.b[a].x,c.b[a].y,c.b[a].r)&&(c.b[a].move=1);for(a in c.b)if(c.b.hasOwnProperty(a)&&1===c.b[a].move){timer=new Date;break}}
function mu(){var b,a;for(b in c.b)if(c.b.hasOwnProperty(b))if("text"===b&&1===c.b[b].move)c.b[b].move=0;else{if("l"===b&&1===c.b[b].move||"r"===b&&1===c.b[b].move)a=new Date,300>a-timer&&(document.getElementById("chat")&&"block"===document.getElementById("chat").style.display&&$("#chat").fadeOut("slow"),send_next(),background_is_load=0,draw(c.image),document.getElementById("chat")&&($("#lines").contents().remove(),$("#chat").fadeIn("slow",function(){$("#nickname").css("display","none");socket.emit("nextpage",
c.order,c.albom,function(){})})),doScene()),c.b[b].move=0,c.b[b].move=0;"count"===b&&1===c.b[b].move&&(c.b[b].move=0,delete c.b[b].tmp,c.b[b].tmp=10<=c.count?"__":"_",doScene(),a=new Date,300>a-timer&&(cv.setAttribute("tabindex","0"),cv.focus(),cv.addEventListener("keyup",keyup,!1)));"notepad"===b&&1===c.b[b].move&&(c.b[b].move=0,a=new Date,300>a-timer&&document.getElementById("chat")&&("block"===document.getElementById("chat").style.display?$("#chat").fadeOut("slow"):($("#lines").contents().remove(),
socket.emit("nickname",Math.floor(11*Math.random()),function(){$("#chat").addClass("nickname-set")}),$("#chat").fadeIn("slow",function(){$("#nickname").css("display","none");socket.emit("nextpage",c.order,c.albom,function(){})}))))}}
function on_text(b){if(1===c.note.show){if(b.x>c.espiral.x&&b.x<c.espiral.x+c.espiral.w&&b.y>c.espiral.y&&b.y<c.espiral.y+c.espiral.h+c.note.h)return 1}else if(b.x>c.espiral.x&&b.x<c.espiral.x+c.espiral.w&&b.y>c.espiral.y&&b.y<c.espiral.y+c.espiral.h)return 1;return 0}
function mm(b){var a,e=getCursorPosition(b),d=0,f,i=0;for(f in c.b)c.b.hasOwnProperty(f)&&(near(e.x,e.y,c.b[f].x,c.b[f].y,c.b[f].r)?(0===c.b[f].re_draw&&(d=1,c.b[f].color=c.b[f].color.replace("0.6","0.9"),"text"===f&&(c.b[f].r*=5)),c.b[f].re_draw=1):(1===c.b[f].re_draw&&(d=1,c.b[f].color=c.b[f].color.replace("0.9","0.6"),"text"===f&&(c.b[f].r/=5)),c.b[f].re_draw=0));for(f in c.b)if(c.b.hasOwnProperty(f)&&1===c.b[f].move){i=1;break}if(1===i){b=e.x-c.m_down.x;a=e.y-c.m_down.y;for(f in c.b)c.b.hasOwnProperty(f)&&
1===c.b[f].move&&(c.b[f].x+=b,c.b[f].y+=a);c.m_down=e}(1===d||1===i)&&doScene()}
function init(){cv=document.getElementById("can");cv.width=0.965*$(document).width();cv.height=0.965*$(document).height();cv.addEventListener("mousemove",mm,!1);cv.addEventListener("mouseup",mu,!1);cv.addEventListener("mousedown",md,!1);var b={width:cv.width,height:cv.height,albom:document.title};debug?(b=Math.sqrt(cv.width*cv.width+cv.height*cv.height),c={albom:"barcelona",b:{l:{x:2*(1/30)*b,y:cv.height/2,color:"rgba(111,0,50,0.6)",move:0,r:1/30*b,re_draw:0},r:{x:cv.width-2*(1/30)*b,y:cv.height/
2,color:"rgba(11,255,50,0.6)",move:0,r:1/30*b,re_draw:0},add:{x:0.85*cv.width,y:0.1*cv.height,color:"rgba(255,255,0,0.6)",move:0,r:0.025*b,re_draw:0},del:{x:0.8*cv.width,y:0.1*cv.height,color:"rgba(255,0,0,0.6)",move:0,r:0.025*b,re_draw:0},text:{x:0.95*cv.width,y:0.08*cv.height,color:"rgba(14,14,14,0.6)",r:0.04*b,re_draw:0},notepad:{x:0.9*cv.width,y:0.1*cv.height,color:"rgba(14,14,14,0.6)",move:0,r:0.025*b,re_draw:0},count:{x:0.05*cv.width,y:0.05*cv.height,color:"rgba(255,155,0,0.6)",move:0,r:1/60*
b,re_draw:0}},m_down:{x:0,y:0},text:{text:"Es hora a comer verduras fritas. Feliz ocho de marzo",maxWidth:200,lineHeight:20,color:"white"},image:"images/DSC_0017.JPG",order:1,count:0},c=jQuery.parseJSON(JSON.stringify(c)),obj_parseInt()):$.ajax({type:"POST",url:"/user",data:b,async:!1,dataType:"json"}).done(function(a){c=jQuery.parseJSON(a);obj_parseInt()});draw(c.image);doScene()};
